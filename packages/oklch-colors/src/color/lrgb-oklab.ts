/** biome-ignore-all lint/correctness/noPrecisionLoss: should be ignore */
import type { LabColor } from './lab-lch';
import type { RGBColor } from './rgb-lrgb';

export function lrgb2oklab(lrgb: RGBColor): LabColor {
  const { r, g, b } = lrgb;
  const L = Math.cbrt(
    0.412_221_470_799_999_93 * r + 0.536_332_536_3 * g + 0.051_445_992_9 * b
  );
  const M = Math.cbrt(
    0.211_903_498_199_999_9 * r +
      0.680_699_545_099_999_9 * g +
      0.107_396_956_6 * b
  );
  const S = Math.cbrt(
    0.088_302_461_899_999_98 * r +
      0.281_718_837_6 * g +
      0.629_978_700_500_000_2 * b
  );

  return {
    l: 0.210_454_255_3 * L + 0.793_617_785 * M - 0.004_072_046_8 * S,
    a: 1.977_998_495_1 * L - 2.428_592_205 * M + 0.450_593_709_9 * S,
    b: 0.025_904_037_1 * L + 0.782_771_766_2 * M - 0.808_675_766 * S,
  };
}

export function oklab2lrgb(oklab: LabColor): RGBColor {
  const { l, a, b } = oklab;
  const L =
    (l * 0.999_999_998_450_519_814_32 +
      0.396_337_792_173_767_856_78 * a +
      0.215_803_758_060_758_803_39 * b) **
    3;
  const M =
    (l * 1.000_000_008_881_760_776_7 -
      0.105_561_342_323_656_349_4 * a -
      0.063_854_174_771_705_903_402 * b) **
    3;
  const S =
    (l * 1.000_000_054_672_410_917_7 -
      0.089_484_182_094_965_759_684 * a -
      1.291_485_537_864_091_739_9 * b) **
    3;

  const res = {
    r:
      +4.076_741_661_347_994 * L -
      3.307_711_590_408_193 * M +
      0.230_969_928_729_428 * S,
    g:
      -1.268_438_004_092_176_3 * L +
      2.609_757_400_663_371_5 * M -
      0.341_319_396_310_219_7 * S,
    b:
      -0.004_196_086_541_837_188 * L -
      0.703_418_614_459_449_3 * M +
      1.707_614_700_930_944_4 * S,
  };

  return res;
}
